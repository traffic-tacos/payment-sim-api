---
description:
globs:
alwaysApply: true
---
ğŸ“Œ payment-sim-api ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ìš© í”„ë¡¬í”„íŠ¸ (Go ë²„ì „ Â· AI ì „ë‹¬ìš©)

ë‹¹ì‹ ì€ Goë¡œ ê²°ì œ ëª¨ì˜ ì„œë¹„ìŠ¤(payment-sim-api)ë¥¼ êµ¬í˜„í•˜ëŠ” ì‹œë‹ˆì–´ ì„œë²„ ì—”ì§€ë‹ˆì–´ì…ë‹ˆë‹¤.
ì¸í”„ë¼/ë°°í¬(K8s/Helm/IaC)ëŠ” ì´ë¯¸ ì¤€ë¹„ë˜ì–´ ìˆìœ¼ë‹ˆ, ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ/ê³„ì•½/ê´€ì¸¡/í…ŒìŠ¤íŠ¸ì—ë§Œ ì§‘ì¤‘í•˜ì„¸ìš”.

## 0) ì»¨í…ìŠ¤íŠ¸
- ëª©ì : ì˜ˆì•½ ì‹œìŠ¤í…œì˜ ê²°ì œ ë‹¨ê³„ ì‹œë®¬ë ˆì´ì…˜(ìŠ¹ì¸/ì‹¤íŒ¨/ì§€ì—°/ëœë¤), ì§€ì •ëœ webhook URLë¡œ ì½œë°± POST.
- ìƒìœ„ í˜¸ì¶œì: api-gateway(REST). ì½œë°± ìˆ˜ì‹  ì¸¡: reservation-api ë˜ëŠ” workerì˜ ê³µê°œ ì—”ë“œí¬ì¸íŠ¸.
- ìš”êµ¬: ê³ RPSì—ì„œ ê°€ë³ê³  ì˜ˆì¸¡ ê°€ëŠ¥í•œ ì§€ì—° ì²˜ë¦¬, ë©±ë“±ì„±, ì„œëª… ê²€ì¦.

## 1) ê¸°ìˆ  ìŠ¤íƒ(ì• í”Œë¦¬ì¼€ì´ì…˜ë§Œ)
- Go 1.22+, linux/arm64
- HTTP ì„œë²„: í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ net/http + chi(ë˜ëŠ” fiber/echo ì¤‘ í•˜ë‚˜ ì„ íƒ)
- HTTP í´ë¼ì´ì–¸íŠ¸: net/http(Client) + ì»¤ìŠ¤í…€ Transport(keep-alive, ì—°ê²° í’€ íŠœë‹)
- ì§ë ¬í™”: encoding/json (í•„ìš” ì‹œ jsoniter ì˜µì…˜ ê°€ëŠ¥)
- ê²€ì¦: go-playground/validator ë˜ëŠ” ìì²´ ê²€ì¦
- ë¡œê¹…: zap(JSON êµ¬ì¡° ë¡œê·¸)
- ê´€ì¸¡: OpenTelemetry(OTLP) + otelhttp ë¯¸ë“¤ì›¨ì–´, Prometheus(client_golang)
- ë™ì‹œì„± ìœ í‹¸: time.Timer/AfterFunc + worker pool(ì½œë°± ë°œì†¡ ìƒí•œ ì œì–´)
- ë©±ë“± ìºì‹œ: ë‚´ì¥ LRU(ristretto ë“±) ë˜ëŠ” in-memory map+TTL(í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ ì‹œ íœ˜ë°œ í—ˆìš©)

## 2) ë„ë©”ì¸/ë™ì‘
- ê²°ì œ ì˜ë„ ìƒì„± â†’ ë‚´ë¶€ ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì§€ì—° í›„ webhook ì „ì†¡ â†’ ìˆ˜ì‹  ì¸¡ 2xx ì‘ë‹µ ì‹œ ì„±ê³µ ì²˜ë¦¬.
- ì‹œë‚˜ë¦¬ì˜¤: approve | fail | delay | random(ê¸°ë³¸ ìŠ¹ì¸ 80%/ì‹¤íŒ¨ 20%, ê°€ë³€)
- ë©±ë“±ì„±: ë™ì¼ `Idempotency-Key` + Body hashë©´ ë™ì¼ `payment_intent_id`ë¡œ ìŠ¤ëƒ…ìƒ· ì‘ë‹µ.

## 3) REST API ê³„ì•½(OpenAPI 3.1 ì‚°ì¶œ)
### 3.1 POST /v1/sim/intent
Headers:
- (ì„ íƒ) Idempotency-Key: <uuid-v4>
Body:
{
  "reservation_id": "rsv_123",
  "amount": 120000,
  "scenario": "approve|fail|delay|random",
  "delay_ms": 0,
  "webhook_url": "https://reservation-api.example.com/internal/payment/webhook",
  "metadata": { "any": "thing" }
}
Logic:
1) ì…ë ¥ ê²€ì¦(í•„ìˆ˜ í•„ë“œ, ê¸ˆì•¡>0, URL ìœ íš¨ì„±).
2) `payment_intent_id = "pay_"+ULID()`. ë©±ë“± í‚¤ê°€ ìˆê³  ë™ì¼ ë°”ë””ë©´ ë™ì¼ ê²°ê³¼ ë°˜í™˜.
3) ì§€ì—° ì„¤ì •: scenarioë³„ ê¸°ë³¸ ì§€ì—°(approve 100~300ms, fail 50~150ms, delay=ì…ë ¥ or 3s, randomì€ ë‚´ë¶€ í™•ë¥ ).
4) ë‚´ë¶€ ìŠ¤ì¼€ì¤„ë§(íƒ€ì´ë¨¸/ì›Œí¬í’€)ì— ë“±ë¡ â†’ ë§Œë£Œ í›„ webhook POST ì˜ˆì•½.
Response 200:
{ "payment_intent_id":"pay_abc", "status":"PENDING", "next":"webhook" }

ì˜¤ë¥˜:
400 VALIDATION_FAILED, 409 IDEMPOTENCY_CONFLICT

### 3.2 POST /v1/sim/webhook/test   (ìš´ì˜ì/í…ŒìŠ¤íŠ¸ìš© ìˆ˜ë™ ë°œì†¡)
Body:
{ "payment_intent_id":"pay_abc", "type":"payment.approved|payment.failed", "webhook_url":"https://..." }
Response: 202 { "sent": true }

### 3.3 GET /v1/sim/intents/{payment_intent_id}
Response:
{ "payment_intent_id":"pay_abc", "reservation_id":"rsv_123", "status":"PENDING|APPROVED|FAILED", "last_attempt_at":"ISO8601" }

### 3.4 í—¬ìŠ¤/ë©”íŠ¸ë¦­
GET /healthz, GET /readyz, GET /metrics (Prometheus)

### ì—ëŸ¬ í¬ë§·(ê³µí†µ)
{ "error": { "code":"STRING_CODE", "message":"...", "trace_id":"..." } }

## 4) Webhook ì‚¬ì–‘(ì†¡ì‹ ì=payment-sim-api)
- Method: POST
- Headers:
  - X-Webhook-Id: <uuid>
  - X-Timestamp: <epoch_ms>
  - X-Signature: sha256=<HMAC_HEX>   // body + timestampë¡œ HMAC, ë¹„ë°€í‚¤ëŠ” í™˜ê²½ë³€ìˆ˜
  - Content-Type: application/json
- Body:
{
  "type": "payment.approved|payment.failed",
  "reservation_id": "rsv_123",
  "payment_intent_id": "pay_abc",
  "amount": 120000,
  "ts": "ISO8601",
  "metadata": { "any": "thing" }
}
- ì¬ì‹œë„: ìˆ˜ì‹ ì ì‘ë‹µì´ 2xx ì•„ë‹ˆë©´ ì§€ìˆ˜ ë°±ì˜¤í”„(1s, 2s, 4s, 8s, â€¦) ìµœëŒ€ NíšŒ.
- ë©±ë“±ì„±: ë™ì¼ X-Webhook-Id ì¬ì „ì†¡ ì‹œ í˜ì´ë¡œë“œ ë™ì¼, ì„œëª… ë™ì¼.
- íƒ€ì„ì•„ì›ƒ: ë‹¨ê±´ ì½œë°± ìš”ì²­ íƒ€ì„ì•„ì›ƒ ê¸°ë³¸ 1s (í™˜ê²½ìœ¼ë¡œ ì˜¤ë²„ë¼ì´ë“œ).

## 5) ë³´ì•ˆ/ì¡°ì‘ ë°©ì§€
- HMAC ë¹„ë°€: WEBHOOK_SECRET (env) â€” X-Signature ìƒì„±.
- ì¬ìƒ ë°©ì§€: X-Timestamp ê¸°ì¤€ Â±5ë¶„ ìœ íš¨(ì„œëª… ì…ë ¥ì— timestamp í¬í•¨).
- ë°œì†¡ ìƒí•œ: ë‚´ë¶€ worker pool + í† í°ë²„í‚·ìœ¼ë¡œ `WEBHOOK_MAX_RPS` ì œí•œ ê°€ëŠ¥.
- ë¡œê¹… ë§ˆìŠ¤í‚¹: ì„œëª…/ë¹„ë°€ ì¼ë¶€ ë§ˆìŠ¤í‚¹.

## 6) ì„±ëŠ¥/ë™ì‹œì„±/íŠœë‹ ëª©í‘œ(ì•± ë ˆë²¨)
- ìì²´ ì—”ë“œí¬ì¸íŠ¸ ì²˜ë¦¬ P95 < 20ms (webhook ì „ì†¡ ì œì™¸).
- HTTP í´ë¼ì´ì–¸íŠ¸ Transport:
  - MaxIdleConns=2000, MaxIdleConnsPerHost=1000, IdleConnTimeout=90s, DisableCompression=false
- ì›¹í›… ë°œì†¡ ì›Œì»¤:
  - í(ë²„í¼ë“œ ì±„ë„) + ì›Œì»¤ N(ì½”ì–´Ã—2~4) + rate limiter(ì˜µì…˜)
  - ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ íë¡œ ì´ë™(Dead-letter in-memory, ìµœëŒ€ NíšŒ)
- ë©”ëª¨ë¦¬: intent ìƒíƒœëŠ” ì¸ë©”ëª¨ë¦¬ ë§µ+TTL ë˜ëŠ” ê²½ëŸ‰ ì„ì‹œìŠ¤í† ë¦¬ì§€(íŒŒì¼/boltdb ì˜µì…˜í™”). (ì§€ì†ì„± ìš”êµ¬ ì—†ìŒ)

## 7) ê´€ì¸¡/ë©”íŠ¸ë¦­/ë¡œê·¸
- OpenTelemetry: otelhttp ë¯¸ë“¤ì›¨ì–´ë¡œ traceparent ìˆ˜ìš©/ì „íŒŒ, ì™¸ë¶€ webhook POSTì—ë„ span ìƒì„±.
- Prometheus ì§€í‘œ:
  - http_requests_total{route,code}, http_request_duration_seconds_bucket
  - webhook_delivery_total{result="success|failure|timeout"}, webhook_latency_seconds_bucket
  - idempotency_hits_total, scenario_counter_total{scenario}
- zap JSON ë¡œê·¸ í•„ë“œ:
  - ts, level, msg, route, status, latency_ms, payment_intent_id, target_host, attempt, result, trace_id

## 8) ì„¤ì •(í™˜ê²½ë³€ìˆ˜ í‚¤ë§Œ; ê°’ ì£¼ì…ì€ ì™¸ë¶€)
- PORT=8080
- WEBHOOK_SECRET=<hmac key> (í•„ìˆ˜)
- DEFAULT_APPROVE_DELAY_MS=200
- DEFAULT_FAIL_DELAY_MS=100
- DEFAULT_DELAY_DELAY_MS=3000
- RANDOM_APPROVE_RATE=0.8
- WEBHOOK_TIMEOUT_MS=1000
- WEBHOOK_MAX_RETRIES=5
- WEBHOOK_BACKOFF_MS=1000    // ìµœì´ˆ ê°„ê²©(ì§€ìˆ˜)
- WEBHOOK_MAX_RPS=500        // 0ì´ë©´ ë¬´ì œí•œ
- OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
- LOG_LEVEL=info

## 9) í…ŒìŠ¤íŠ¸/í’ˆì§ˆ(ì½”ë“œ ì¤‘ì‹¬)
- ë‹¨ìœ„: ì…ë ¥ ê²€ì¦, HMAC ì„œëª…, ë©±ë“± ìºì‹œ, ì‹œë‚˜ë¦¬ì˜¤ ë¶„ê¸°, ë°±ì˜¤í”„/ì¬ì‹œë„ ë¡œì§, rate limiter.
- í†µí•©: ì„ì‹œ ìˆ˜ì‹  ì„œë²„(httptest.Server)ë¡œ webhook ì„±ê³µ/ì‹¤íŒ¨/ì§€ì—°/íƒ€ì„ì•„ì›ƒ ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦.
- ë¶€í•˜: k6/http ë˜ëŠ” vegeta ìŠ¤í¬ë¦½íŠ¸ ë™ë´‰(ì˜ë„ ìƒì„± 2k rps, ì½œë°± 1k rps ìƒí•œ) â€” ì‹¤í–‰ì€ ì™¸ë¶€ì—ì„œ.
- ê³„ì•½: OpenAPI ë¬¸ì„œ(openapi/payment-sim.yaml) ìƒì„± ë° ìŠ¤í‚¤ë§ˆ ê²€ì¦ í…ŒìŠ¤íŠ¸.

## 10) ë¦¬í¬ì§€í† ë¦¬ êµ¬ì¡°(ì• í”Œë¦¬ì¼€ì´ì…˜ë§Œ)
- /cmd/payment-sim-api/main.go
- /internal/http/           // ë¼ìš°í„°, í•¸ë“¤ëŸ¬, ë¯¸ë“¤ì›¨ì–´(otelhttp, request-id)
- /internal/service/        // intent ìƒì„±, ìŠ¤ì¼€ì¤„ë§, ìƒíƒœê´€ë¦¬
- /internal/webhook/        // HMAC ì„œëª…, ë°œì†¡ ì›Œì»¤, ì¬ì‹œë„/ë°±ì˜¤í”„, rate limit
- /internal/observability/  // otel, prometheus, logger
- /internal/config/         // env íŒŒì‹±, ê¸°ë³¸ê°’
- /internal/store/          // ë©±ë“±/ì˜ë„ ìƒíƒœ(in-memory TTL, ì„ íƒì  ì¸í„°í˜ì´ìŠ¤)
- /openapi/payment-sim.yaml
- /scripts/run_local.sh
- Makefile (lint/test/build), Dockerfile, README.md
- /test/ (unit + integration)

## 11) ì—ëŸ¬ ì½”ë“œ(ê³ ì • ë¬¸ìì—´)
- 400 VALIDATION_FAILED
- 401 UNAUTHENTICATED  (í•„ìš” ì‹œ)
- 409 IDEMPOTENCY_CONFLICT
- 429 RATE_LIMITED
- 500 WEBHOOK_DISPATCH_ERROR
- 504 WEBHOOK_TIMEOUT

### ìµœì¢… ì§€ì‹œ
ìœ„ ëª…ì„¸ì— ë”°ë¼ payment-sim-apiì˜ **ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ/ê³„ì•½/ê´€ì¸¡/í…ŒìŠ¤íŠ¸**ë¥¼ ìƒì„±í•˜ì„¸ìš”.
ì¸í”„ë¼/ë°°í¬ ìŠ¤í™(K8s/Helm/IaC)ì€ í¬í•¨í•˜ì§€ ë§ê³ , í™˜ê²½ë³€ìˆ˜ í‚¤ë§Œ ë…¸ì¶œí•˜ë©° ê°’ ì£¼ì…ì€ ì™¸ë¶€ì—ì„œ ì²˜ë¦¬ë˜ë„ë¡ í•˜ì„¸ìš”.