---
description:
globs:
alwaysApply: true
---
ğŸ“Œ payment-sim-api ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ë³´ (ìˆœìˆ˜ gRPC ë²„ì „)

Traffic Tacos MSA Platformì˜ **ìˆœìˆ˜ gRPC ê²°ì œ ì‹œë®¬ë ˆì´ì…˜ ì„œë¹„ìŠ¤**ì…ë‹ˆë‹¤.
inventory-api íŒ¨í„´ì„ ë”°ë¼ ìˆœìˆ˜ gRPCë¡œ êµ¬í˜„ë˜ì—ˆìœ¼ë©°, ì¤‘ì•™í™”ëœ proto-contracts ëª¨ë“ˆì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

## í˜„ì¬ êµ¬í˜„ ìƒíƒœ
- ëª©ì : ì˜ˆì•½ ì‹œìŠ¤í…œì˜ ê²°ì œ ë‹¨ê³„ ì‹œë®¬ë ˆì´ì…˜(ìŠ¹ì¸/ì‹¤íŒ¨/ì§€ì—°/ëœë¤), EventBridge + Webhook ì´ì¤‘ ì²˜ë¦¬
- ìƒìœ„ í˜¸ì¶œì: gateway-api(gRPC), reservation-api(gRPC). ì½œë°± ìˆ˜ì‹  ì¸¡: reservation-api webhook + EventBridge
- ìš”êµ¬: 30k RPS ì²˜ë¦¬ ëª©í‘œ, inventory-apiì™€ ë™ì¼í•œ ìˆœìˆ˜ gRPC ì•„í‚¤í…ì²˜

## 1) ê¸°ìˆ  ìŠ¤íƒ(í˜„ì¬ êµ¬í˜„)
- Go 1.24+, multi-arch (darwin/linux arm64/amd64)
- gRPC ì„œë²„: google.golang.org/grpc + reflection (í¬íŠ¸ 8030)
- HTTP ì„œë²„: net/http (í—¬ìŠ¤ì²´í¬ + ë©”íŠ¸ë¦­ìŠ¤ë§Œ, í¬íŠ¸ 8031)
- Proto ê³„ì•½: github.com/traffic-tacos/proto-contracts (ì¤‘ì•™í™”ëœ ëª¨ë“ˆ)
- AWS í†µí•©: EventBridge + SQS (AWS SDK v2, í”„ë¡œí•„: tacos)
- HTTP í´ë¼ì´ì–¸íŠ¸: net/http(Client) (webhook ë°œì†¡ìš©)
- ë¡œê¹…: zap(JSON êµ¬ì¡° ë¡œê·¸)
- ê´€ì¸¡: Prometheus(client_golang) + health endpoints
- ë™ì‹œì„±: goroutine + time.Timer (webhook ì§€ì—° ì²˜ë¦¬)
- ìƒíƒœ ì €ì¥: in-memory map (í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ ì‹œ íœ˜ë°œ)

## 2) gRPC ì„œë¹„ìŠ¤ êµ¬í˜„
- ê²°ì œ ì˜ë„ ìƒì„± â†’ EventBridge ì´ë²¤íŠ¸ ë°œí–‰ + HTTP webhook ì´ì¤‘ ì²˜ë¦¬
- ì‹œë‚˜ë¦¬ì˜¤: PAYMENT_SCENARIO_APPROVE|FAIL|DELAY|RANDOM (proto enum)
- ìƒíƒœ: PAYMENT_STATUS_PENDING â†’ COMPLETED|FAILED (proto enum)

## 3) gRPC API ê³„ì•½ (proto-contracts ëª¨ë“ˆ ê¸°ë°˜)

### ì‚¬ìš© ê°€ëŠ¥í•œ gRPC ë©”ì„œë“œ:
- `CreatePaymentIntent` - ê²°ì œ ì¸í…íŠ¸ ìƒì„±
- `GetPaymentStatus` - ê²°ì œ ìƒíƒœ ì¡°íšŒ
- `ProcessPayment` - ê²°ì œ ì²˜ë¦¬
- `CancelPayment` - ê²°ì œ ì·¨ì†Œ
- `ListPayments` - ê²°ì œ ëª©ë¡ ì¡°íšŒ
- `SimulateWebhook` - ì›¹í›… ì‹œë®¬ë ˆì´ì…˜

### 3.1 CreatePaymentIntent
Request:
{
  "reservation_id": "rsv_123",
  "user_id": "user_456",
  "amount": {"amount": 120000, "currency": "KRW"},
  "scenario": "PAYMENT_SCENARIO_APPROVE",
  "webhook_url": "https://reservation-api.example.com/internal/payment/webhook"
}
Response:
{
  "payment_intent_id": "uuid",
  "status": "PAYMENT_STATUS_PENDING"
}

### 3.2 GetPaymentStatus
Request:
{
  "payment_intent_id": "uuid",
  "user_id": "user_456"
}
Response:
{
  "payment": {
    "payment_intent_id": "uuid",
    "reservation_id": "rsv_123",
    "status": "PAYMENT_STATUS_PENDING|COMPLETED|FAILED",
    "amount": {"amount": "120000", "currency": "KRW"}
  }
}

### 3.2 POST /v1/sim/webhook/test   (ìš´ì˜ì/í…ŒìŠ¤íŠ¸ìš© ìˆ˜ë™ ë°œì†¡)
Body:
{ "payment_intent_id":"pay_abc", "type":"payment.approved|payment.failed", "webhook_url":"https://..." }
Response: 202 { "sent": true }

### 3.3 GET /v1/sim/intents/{payment_intent_id}
Response:
{ "payment_intent_id":"pay_abc", "reservation_id":"rsv_123", "status":"PENDING|APPROVED|FAILED", "last_attempt_at":"ISO8601" }

### 3.4 í—¬ìŠ¤/ë©”íŠ¸ë¦­
GET /healthz, GET /readyz, GET /metrics (Prometheus)

### ì—ëŸ¬ í¬ë§·(ê³µí†µ)
{ "error": { "code":"STRING_CODE", "message":"...", "trace_id":"..." } }

## 4) Webhook ì‚¬ì–‘(ì†¡ì‹ ì=payment-sim-api)
- Method: POST
- Headers:
  - X-Webhook-Id: <uuid>
  - X-Timestamp: <epoch_ms>
  - X-Signature: sha256=<HMAC_HEX>   // body + timestampë¡œ HMAC, ë¹„ë°€í‚¤ëŠ” í™˜ê²½ë³€ìˆ˜
  - Content-Type: application/json
- Body:
{
  "type": "payment.approved|payment.failed",
  "reservation_id": "rsv_123",
  "payment_intent_id": "pay_abc",
  "amount": 120000,
  "ts": "ISO8601",
  "metadata": { "any": "thing" }
}
- ì¬ì‹œë„: ìˆ˜ì‹ ì ì‘ë‹µì´ 2xx ì•„ë‹ˆë©´ ì§€ìˆ˜ ë°±ì˜¤í”„(1s, 2s, 4s, 8s, â€¦) ìµœëŒ€ NíšŒ.
- ë©±ë“±ì„±: ë™ì¼ X-Webhook-Id ì¬ì „ì†¡ ì‹œ í˜ì´ë¡œë“œ ë™ì¼, ì„œëª… ë™ì¼.
- íƒ€ì„ì•„ì›ƒ: ë‹¨ê±´ ì½œë°± ìš”ì²­ íƒ€ì„ì•„ì›ƒ ê¸°ë³¸ 1s (í™˜ê²½ìœ¼ë¡œ ì˜¤ë²„ë¼ì´ë“œ).

## 5) ë³´ì•ˆ/ì¡°ì‘ ë°©ì§€
- HMAC ë¹„ë°€: WEBHOOK_SECRET (env) â€” X-Signature ìƒì„±.
- ì¬ìƒ ë°©ì§€: X-Timestamp ê¸°ì¤€ Â±5ë¶„ ìœ íš¨(ì„œëª… ì…ë ¥ì— timestamp í¬í•¨).
- ë°œì†¡ ìƒí•œ: ë‚´ë¶€ worker pool + í† í°ë²„í‚·ìœ¼ë¡œ `WEBHOOK_MAX_RPS` ì œí•œ ê°€ëŠ¥.
- ë¡œê¹… ë§ˆìŠ¤í‚¹: ì„œëª…/ë¹„ë°€ ì¼ë¶€ ë§ˆìŠ¤í‚¹.

## 6) ì„±ëŠ¥/ë™ì‹œì„±/íŠœë‹ ëª©í‘œ(ì•± ë ˆë²¨)
- ìì²´ ì—”ë“œí¬ì¸íŠ¸ ì²˜ë¦¬ P95 < 20ms (webhook ì „ì†¡ ì œì™¸).
- HTTP í´ë¼ì´ì–¸íŠ¸ Transport:
  - MaxIdleConns=2000, MaxIdleConnsPerHost=1000, IdleConnTimeout=90s, DisableCompression=false
- ì›¹í›… ë°œì†¡ ì›Œì»¤:
  - í(ë²„í¼ë“œ ì±„ë„) + ì›Œì»¤ N(ì½”ì–´Ã—2~4) + rate limiter(ì˜µì…˜)
  - ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ íë¡œ ì´ë™(Dead-letter in-memory, ìµœëŒ€ NíšŒ)
- ë©”ëª¨ë¦¬: intent ìƒíƒœëŠ” ì¸ë©”ëª¨ë¦¬ ë§µ+TTL ë˜ëŠ” ê²½ëŸ‰ ì„ì‹œìŠ¤í† ë¦¬ì§€(íŒŒì¼/boltdb ì˜µì…˜í™”). (ì§€ì†ì„± ìš”êµ¬ ì—†ìŒ)

## 7) ê´€ì¸¡/ë©”íŠ¸ë¦­/ë¡œê·¸
- OpenTelemetry: otelhttp ë¯¸ë“¤ì›¨ì–´ë¡œ traceparent ìˆ˜ìš©/ì „íŒŒ, ì™¸ë¶€ webhook POSTì—ë„ span ìƒì„±.
- Prometheus ì§€í‘œ:
  - http_requests_total{route,code}, http_request_duration_seconds_bucket
  - webhook_delivery_total{result="success|failure|timeout"}, webhook_latency_seconds_bucket
  - idempotency_hits_total, scenario_counter_total{scenario}
- zap JSON ë¡œê·¸ í•„ë“œ:
  - ts, level, msg, route, status, latency_ms, payment_intent_id, target_host, attempt, result, trace_id

## 8) ì„¤ì •(í™˜ê²½ë³€ìˆ˜ - í˜„ì¬ êµ¬í˜„)
- GRPC_PORT=8030 (gRPC ì„œë²„ í¬íŠ¸)
- AWS_PROFILE=tacos (AWS í”„ë¡œí•„, í•„ìˆ˜)
- AWS_REGION=ap-northeast-2 (AWS ë¦¬ì „)
- EVENT_BUS_NAME=ticket-reservation-events (EventBridge ë²„ìŠ¤)
- PAYMENT_EVENT_SOURCE=payment-sim-api (ì´ë²¤íŠ¸ ì†ŒìŠ¤)
- PAYMENT_WEBHOOK_QUEUE_URL=<SQS URL> (í•„ìˆ˜)
- WEBHOOK_SECRET=payment-sim-dev-secret (HMAC í‚¤)
- DEFAULT_DELAY_MS=2000 (ì§€ì—° ì‹œê°„)
- DEFAULT_SCENARIO=approve (ê¸°ë³¸ ì‹œë‚˜ë¦¬ì˜¤)
- ENVIRONMENT=development|production

## 9) í…ŒìŠ¤íŠ¸/í’ˆì§ˆ(ì½”ë“œ ì¤‘ì‹¬)
- ë‹¨ìœ„: ì…ë ¥ ê²€ì¦, HMAC ì„œëª…, ë©±ë“± ìºì‹œ, ì‹œë‚˜ë¦¬ì˜¤ ë¶„ê¸°, ë°±ì˜¤í”„/ì¬ì‹œë„ ë¡œì§, rate limiter.
- í†µí•©: ì„ì‹œ ìˆ˜ì‹  ì„œë²„(httptest.Server)ë¡œ webhook ì„±ê³µ/ì‹¤íŒ¨/ì§€ì—°/íƒ€ì„ì•„ì›ƒ ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦.
- ë¶€í•˜: k6/http ë˜ëŠ” vegeta ìŠ¤í¬ë¦½íŠ¸ ë™ë´‰(ì˜ë„ ìƒì„± 2k rps, ì½œë°± 1k rps ìƒí•œ) â€” ì‹¤í–‰ì€ ì™¸ë¶€ì—ì„œ.
- ê³„ì•½: OpenAPI ë¬¸ì„œ(openapi/payment-sim.yaml) ìƒì„± ë° ìŠ¤í‚¤ë§ˆ ê²€ì¦ í…ŒìŠ¤íŠ¸.

## 10) ë¦¬í¬ì§€í† ë¦¬ êµ¬ì¡°(ì• í”Œë¦¬ì¼€ì´ì…˜ë§Œ)
- /cmd/payment-sim-api/main.go
- /internal/http/           // ë¼ìš°í„°, í•¸ë“¤ëŸ¬, ë¯¸ë“¤ì›¨ì–´(otelhttp, request-id)
- /internal/service/        // intent ìƒì„±, ìŠ¤ì¼€ì¤„ë§, ìƒíƒœê´€ë¦¬
- /internal/webhook/        // HMAC ì„œëª…, ë°œì†¡ ì›Œì»¤, ì¬ì‹œë„/ë°±ì˜¤í”„, rate limit
- /internal/observability/  // otel, prometheus, logger
- /internal/config/         // env íŒŒì‹±, ê¸°ë³¸ê°’
- /internal/store/          // ë©±ë“±/ì˜ë„ ìƒíƒœ(in-memory TTL, ì„ íƒì  ì¸í„°í˜ì´ìŠ¤)
- /openapi/payment-sim.yaml
- /scripts/run_local.sh
- Makefile (lint/test/build), Dockerfile, README.md
- /test/ (unit + integration)

## 11) ì—ëŸ¬ ì½”ë“œ(ê³ ì • ë¬¸ìì—´)
- 400 VALIDATION_FAILED
- 401 UNAUTHENTICATED  (í•„ìš” ì‹œ)
- 409 IDEMPOTENCY_CONFLICT
- 429 RATE_LIMITED
- 500 WEBHOOK_DISPATCH_ERROR
- 504 WEBHOOK_TIMEOUT

## í˜„ì¬ êµ¬í˜„ ìƒíƒœ (2024ë…„ 12ì›”)
âœ… **ìˆœìˆ˜ gRPC ì„œë¹„ìŠ¤**: inventory-api íŒ¨í„´ ì™„ì „ ì ìš©
âœ… **Proto ê³„ì•½**: github.com/traffic-tacos/proto-contracts ëª¨ë“ˆ ì‚¬ìš©
âœ… **EventBridge í†µí•©**: AWS EventBridge + SQS ì‹¤ì œ ì—°ë™
âœ… **Webhook ë°œì†¡**: HTTP ì½œë°±ê³¼ EventBridge ì´ì¤‘ ì²˜ë¦¬
âœ… **MSA í‘œì¤€**: Dockerfile, Makefile, grpcui, Prometheus ì™„ë¹„
âœ… **í¬íŠ¸ êµ¬ì„±**: 8030 (gRPC), 8031 (Health + Metrics)

## ê°œë°œ/í…ŒìŠ¤íŠ¸ ëª…ë ¹ì–´
```bash
# ë¹Œë“œ ë° ì‹¤í–‰
make build
./bin/payment-sim-api

# gRPC í…ŒìŠ¤íŠ¸
grpcui -plaintext localhost:8030
grpcurl -plaintext localhost:8030 list

# í—¬ìŠ¤ì²´í¬
curl http://localhost:8031/health
```

### ìµœì¢… ì§€ì‹œ
payment-sim-apiëŠ” í˜„ì¬ **ìˆœìˆ˜ gRPC ì•„í‚¤í…ì²˜**ë¡œ ì™„ì „íˆ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.
proto-contracts ëª¨ë“ˆì„ ì‚¬ìš©í•˜ì—¬ MSA í‘œì¤€ì„ ì¤€ìˆ˜í•˜ë©°, EventBridge + Webhook ì´ì¤‘ ì²˜ë¦¬ë¥¼ í†µí•´ ê³ ê°€ìš©ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.